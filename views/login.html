<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Login</title>

    <!-- Custom fonts for this template-->
    <link href="../templates/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="../templates/css/sb-admin-2.min.css" rel="stylesheet">
    <link href="../templates/css/login.css" rel="stylesheet">

</head>


<body class="bg-gradient-primary">

    <div class="login-container">
        <div class="logo">
            <i class="fas fa-hotel"></i>
            <h4>Sistema de Reservas de Hotel</h4>
        </div>

        <h5 class="text-center mb-2">Bienvenido, inicie sesi贸n</h5>
        <div class="alert d-none" id="div_msg" >
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
            <h5><i class="icon fas fa-user"></i> <div id="div_msg_title"></div></h5>
            <div id="div_msg_content"></div>
        </div>
        <form class="user" method="post">
            <div class="form-group">
                <label for="username">Usuario</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                    </div>
                    <input type="text" class="form-control" id="username" name="username" placeholder="Ingrese su usuario">
                </div>
            </div>

            <div class="form-group">
                <label for="password">Contrase帽a</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    </div>
                    <input type="password" class="form-control" id="password" name="password" placeholder="Ingrese su contrase帽a">
                </div>
            </div>

            <button class="btn btn-login btn-block text-white" id="btnEntrar">Iniciar Sesi贸n</button>

        </form>
    </div>


    <!-- Modal -->
    <div class="modal fade " id="msg_modalWindows" >
      <div class="modal-dialog modal-lg ">
        <div class="modal-content " id="modalstyle">
          <div class="modal-header " id="content_title">
            <h4 class="modal-title" id="msgTitle" > </h4>
            <button type="button" class="close " data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body " id="msgContent" >
                <!-- Contenido creado dinamicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" id="btnModal_Close" class="btn btn-default flat" data-dismiss="modal" >Cerrar</button>                
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal -->

   
    <!-- Bootstrap core JavaScript-->
    <script src="../templates/vendor/jquery/jquery.min.js"></script>
    <script src="../templates/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../templates/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../templates/js/sb-admin-2.min.js"></script>

    <!-- SCRIPT DE VALIDACIONES-->
    <script type="text/javascript" src="../scripts/validaciones.js" language="javascript"></script>
    <!-- SCRIPT DEL MODAL -->
    <script type="text/javascript" src="includes/layout_msg_windows.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="const.js"></script>

    <script>

        //Verificamos validacion en cada control
        function validar(){     
            var isValid=false;
            msgvalidarcontrols = "";
          
            if( !validate_result("exists",$("#username").val(), "username"))
                msgvalidarcontrols += "<span class='badge badge-danger'>Digite su usuario</span>  ";

            if( !validate_result("exists",$("#password").val(), "password"))
                msgvalidarcontrols += "<span class='badge badge-danger'>Digite su contrase帽a</span>  ";

            if (msgvalidarcontrols == "") isValid=true; //si no cargo texto de validacion todo esta bn
            return isValid;
        }//fin validacion en cada control 


        function modal_message(msgTitle, info, showLoading){   
            //Ejecucion ventana modal
            msgShow_Simple(msgTitle, info, showLoading);
        }


        document.getElementById('btnEntrar').addEventListener("click", async function (e) {
            e.preventDefault();

            if(validar()){ 
                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;

                const divMsg = document.getElementById("div_msg");
                const title = document.getElementById("div_msg_title");
                const content = document.getElementById("div_msg_content");

                divMsg.className = "alert mt-3";

                try {
                    
                    const response = await axios.post(`${getServerUrl()}/auth/login`, {
                        username: username,
                        password: password
                    });

                    const token = response.data.access_token;
                    const user = response.data.user; //  Aqu铆 est谩 la info que viene del backend

                    divMsg.classList.add("alert-success");
                    title.innerText = "Autenticado";
                    content.innerText = "Validado ingresando al sistema...";
                    divMsg.classList.remove("d-none");

                   
                    localStorage.setItem("token", token);
                    localStorage.setItem("user", JSON.stringify(user)); //  guarda todo el objeto

                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 500);

                } catch (error) {
                    
                    divMsg.classList.add("alert-danger");
                    title.innerText = "Error Autenticaci贸n";

                    if (error.response) {
                        content.innerText = error.response.data.detail;
                    } else {
                        content.innerText = "Error de conexi贸n con el servidor.";
                    }
                    
                    divMsg.classList.remove("d-none");
                }
            
            }else{
                modal_message("Validando informaci贸n requerida", "-1 Complete la informaci贸n en los campos marcados.<br>"+msgvalidarcontrols, 0); 
                
            }//END IF
        });
    </script>

</body>

</html>